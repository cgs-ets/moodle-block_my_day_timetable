define ("block_my_day_timetable/control",["jquery","core/log","core/pubsub","core/ajax","core/str"],function(a,b,c,d,e){'use strict';function f(a,b,c,d,e,f){var g=this;g.date=b;g.region=a;g.userid=e;g.instanceid=c;g.displaypreference=d;g.title=f;g.role=a.data("timetablerole");g.username=a.data("timetableuser")}f.prototype.main=function(){var d=this;d.refreshPeriodLayout();d.region.removeClass("isloading");d.navigatePreviousDay();d.navigateNextDay();d.timetableVisibility();a(window).on("resize",function(){d.refreshPeriodLayout()});c.subscribe("nav-drawer-toggle-end",function(){b.debug("resizing timetable");d.refreshPeriodLayout()})};f.prototype.refreshPeriodLayout=function(){var a=this,b=70,c=a.region.data("num-breaks"),d=a.region.outerWidth()-c*b,e=a.region.data("num-periods")-c,f=d/e;a.region.removeClass("view-stacked");a.region.removeClass("view-minimal");a.region.removeClass("view-wrapped");a.region.removeClass("view-full");if(520>d||65>f){a.setPeriodWidth("view-stacked","100%","100%")}else if(100>f){var g=2*Math.round(e/2),f=d/g;a.setPeriodWidth("view-minimal view-wrapped",2*f+"px",b+"px")}else if(180>f){a.setPeriodWidth("view-minimal",f+"px",b+"px")}else{a.setPeriodWidth("view-full",f+"px",b+"px")}};f.prototype.setPeriodWidth=function(a,b,c){var d=this;d.region.addClass(a);d.region.find(".period").css({width:b});d.region.find(".period.break").css({width:c})};f.prototype.navigatePreviousDay=function(){var c=this,e=parseInt(c.instanceid);a("#inst"+e+".block_my_day_timetable").on("click",".timetable-prev",function(){c.region.addClass("fetchingdata");d.call([{methodname:"block_my_day_timetable_get_timetable_for_date",args:{timetableuser:c.username,timetablerole:c.role,nav:0,date:c.date,instanceid:e},done:function done(a){b.debug("Timetable values retrieved successfuly.");c.refreshLayout(a.html)},fail:function fail(a){b.error("block_my_day_timetable. NavigatePreviousDay: Unable to get timetable.");b.debug(a);c.timetableUnavailable()}}])})};f.prototype.navigateNextDay=function(){var c=this,e=parseInt(c.instanceid);a("#inst"+e+".block_my_day_timetable").on("click",".timetable-next",function(){c.region.addClass("fetchingdata");b.debug("Nav next day user: "+c.user+" Role: "+c.role+" Date: "+c.date+"instanceid"+e);d.call([{methodname:"block_my_day_timetable_get_timetable_for_date",args:{timetableuser:c.username,timetablerole:c.role,nav:1,date:c.date,instanceid:c.instanceid},done:function done(a){b.debug("Timetable values retrieved successfuly.");c.refreshLayout(a.html)},fail:function fail(a){b.error("block_my_day_timetable. NavigateNextDay: Unable to get timetable.");b.debug(a);c.timetableUnavailable()}}])})};f.prototype.timetableVisibility=function(){var b=this;a("#inst"+b.instanceid+".block_my_day_timetable").on("click",".timetable-invisible",function(){b.region.removeClass("timetable-maximised");b.region.addClass("timetable-minimised");b.region.find(".timetable-title").text(b.title);b.savePreferences(1)});a("#inst"+b.instanceid+".block_my_day_timetable").on("click",".timetable-visible",function(){b.region.removeClass("timetable-minimised");b.region.addClass("timetable-maximised");b.region.find(".timetable-title").text(b.region.data("timetableday"));b.savePreferences(0);b.refreshPeriodLayout()})};f.prototype.savePreferences=function(a){var c=this,e=[{name:"block_my_day_timetable_collapsed",value:a,userid:c.userid}];d.call([{methodname:"core_user_set_user_preferences",args:{preferences:e},done:function done(){b.debug("Preference saved")}}])};f.prototype.refreshLayout=function(b){var c=this;c.region.fadeOut(300,function(){c.region.replaceWith(b);c.region.show();c.region=a("[data-region=\"block_my_day_timetable-instance-"+c.instanceid+"\"]");c.date=c.region.data("timetabledate");c.region.removeClass("isloading");c.region.removeClass("fetchingdata");c.refreshPeriodLayout()})};f.prototype.timetableUnavailable=function(){var b=this,c=e.get_string("timetableunavailable","block_my_day_timetable");a.when(c).done(function(a){b.region.replaceWith("<h5>"+a+"</h5>")})};return{init:function(c,d,e,g,h){b.debug("block_my_day_timetable/control: initializing controls of the my_day_timetable block instance "+c);var i=a("[data-region=\"block_my_day_timetable-instance-"+c+"\"]").first();if(!i.length){b.debug("block_my_day_timetable/control: wrapping region not found!");return}var j=new f(i,d,c,e,g,h);j.main()}}});
//# sourceMappingURL=control.min.js.map
