{"version":3,"sources":["../src/control.js"],"names":["define","$","Log","PubSub","Ajax","Str","DailyTimetableControl","region","date","instanceid","displaypreference","userid","title","self","parseInt","role","data","username","prototype","main","refreshPeriodLayout","removeClass","setupEvents","window","on","subscribe","debug","unbind","navigate","addClass","find","text","savePreferences","breakWidth","numBreaks","timetableWidth","outerWidth","numPeriods","potentialWidth","setPeriodWidth","evenPeriods","Math","round","classes","periodWidth","css","direction","args","timetableuser","timetablerole","nav","JSON","stringify","call","methodname","done","response","refreshLayout","html","fail","reason","error","timetableUnavailable","value","preferences","htmlResult","fadeOut","replaceWith","show","unavailablestr","get_string","when","localizedString","init","first","length","control"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Provides the block_my_day_timetable/control module\n *\n * @package   block_my_day_timetable\n * @category  output\n * @copyright 2020 Michael Vangelovski\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * @module block_my_day_timetable/control\n */\ndefine(['jquery', 'core/log', 'core/pubsub', 'core/ajax', 'core/str'], function($, Log, PubSub, Ajax, Str) {\n    'use strict';\n\n    /**\n     * Initializes the block controls.\n     */\n    function init(instanceid, date, displaypreference, userid, title) {\n        Log.debug('block_my_day_timetable/control: initializing controls of the my_day_timetable block instance ' + instanceid);\n\n        var region = $('[data-region=\"block_my_day_timetable-instance-' + instanceid + '\"]').first();\n\n        if (!region.length) {\n            Log.debug('block_my_day_timetable/control: wrapping region not found!');\n            return;\n        }\n\n        var control = new DailyTimetableControl(region, date, instanceid, displaypreference, userid, title);\n        control.main();\n    }\n\n    /**\n     * Controls a single my_day_timetable block instance contents.\n     *\n     * @constructor\n     * @param {jQuery} region\n     */\n    function DailyTimetableControl(region, date, instanceid, displaypreference, userid, title) {\n        var self = this;\n        self.date = date;\n        self.region = region;\n        self.userid = userid;\n        self.instanceid = parseInt(instanceid);\n        self.displaypreference = displaypreference;\n        self.title = title;\n        self.role = region.data(\"timetablerole\");\n        self.username = region.data(\"timetableuser\");\n    }\n\n    /**\n     * Run the controller.\n     *\n     */\n    DailyTimetableControl.prototype.main = function () {\n        var self = this;\n\n        // Initialise width.\n        self.refreshPeriodLayout();\n        self.region.removeClass('isloading');\n\n        // Setup nav events\n        self.setupEvents();\n\n        // Watch resize to adjust width.\n        $(window).on('resize', function(){\n            self.refreshPeriodLayout();\n        });\n\n        // Subscribe to nav drawer event and resize when it completes.\n        PubSub.subscribe('nav-drawer-toggle-end', function(el){\n            Log.debug('resizing timetable');\n            self.refreshPeriodLayout();\n        });\n    };\n\n    DailyTimetableControl.prototype.setupEvents = function () {\n        var self = this;\n        // Unbind all existing events.\n        $('#inst' + self.instanceid + '.block_my_day_timetable').unbind();\n        \n        // Set up navigation events.\n        $('#inst' + self.instanceid + '.block_my_day_timetable').on('click', '.timetable-prev', function () {\n            self.navigate(0);\n        });\n        $('#inst' + self.instanceid + '.block_my_day_timetable').on('click', '.timetable-next', function () {\n            self.navigate(1);\n        });\n\n        // Hide timetable\n        $('#inst' + self.instanceid + '.block_my_day_timetable').on('click', '.timetable-invisible', function () {\n            self.region.removeClass('timetable-maximised');\n            self.region.addClass('timetable-minimised');\n            //Title\n            self.region.find('.timetable-title').text(self.title);\n            self.savePreferences(1);\n        });\n\n        // Show timetable\n        $('#inst' + self.instanceid + '.block_my_day_timetable').on('click', '.timetable-visible', function () {\n            self.region.removeClass('timetable-minimised');\n            self.region.addClass('timetable-maximised');\n            //Title\n            self.region.find('.timetable-title').text(self.region.data('timetableday'));\n            self.savePreferences(0);\n            self.refreshPeriodLayout();\n        });\n    }\n\n    /**\n     * Determine period widths.\n     *\n     * @method\n     */\n    DailyTimetableControl.prototype.refreshPeriodLayout = function () {\n        var self = this;\n\n        var breakWidth = 70;\n        var numBreaks = self.region.data('num-breaks');\n        var timetableWidth = self.region.outerWidth() - (numBreaks * breakWidth);\n        var numPeriods = self.region.data('num-periods') - numBreaks;\n        var potentialWidth = timetableWidth / numPeriods;\n\n        self.region.removeClass('view-stacked');\n        self.region.removeClass('view-minimal');\n        self.region.removeClass('view-wrapped');\n        self.region.removeClass('view-full');\n\n        if ( timetableWidth < 520 || potentialWidth < 65 ) {\n            // At this point, it really needs to be stacked.\n            self.setPeriodWidth('view-stacked',\"100%\",\"100%\");\n        } else if ( potentialWidth < 100 ) {\n            var evenPeriods = 2 * Math.round(numPeriods / 2); // it would work well over 2 lines, so wrap it\n            var potentialWidth = timetableWidth / evenPeriods;\n            self.setPeriodWidth('view-minimal view-wrapped', potentialWidth*2 + \"px\", breakWidth + \"px\");\n        } else if ( potentialWidth < 180 ) {\n            // Works nicely on one line if minimised.\n            self.setPeriodWidth('view-minimal', potentialWidth + \"px\",breakWidth + \"px\");\n        } else {\n            // Works nicely on one line.\n            self.setPeriodWidth('view-full', potentialWidth + \"px\",breakWidth + \"px\");\n        }\n    };\n\n    /**\n     * Set period widths.\n     *\n     * @method\n     */\n    DailyTimetableControl.prototype.setPeriodWidth = function (classes, periodWidth, breakWidth) {\n        var self = this;\n        self.region.addClass(classes);\n        self.region.find('.period').css({\"width\": periodWidth});\n        self.region.find('.period.break').css({\"width\": breakWidth});\n    };\n\n    /**\n     * Navigate to Next day.\n     *\n     * @method\n     */\n    DailyTimetableControl.prototype.navigate = function (direction) {\n        var self = this;\n        self.region.addClass('fetchingdata');\n        var args = {\n            timetableuser: self.username,\n            timetablerole: self.role,\n            nav: direction,\n            date: self.date,\n            instanceid: self.instanceid\n        };\n        Log.debug('block_my_day_timetable/content: Navigate timetable: ' + JSON.stringify(args));\n        Ajax.call([{\n            methodname: 'block_my_day_timetable_get_timetable_html_for_date',\n            args: args,\n            done:function(response){\n                Log.debug(('Timetable values retrieved successfuly.'));\n                self.refreshLayout(response.html);\n            },\n           fail: function(reason) {\n                Log.error('block_my_day_timetable. NavigateNextDay: Unable to get timetable.');\n                Log.debug(reason);\n                self.timetableUnavailable();\n            }\n        }]);\n    };\n\n    DailyTimetableControl.prototype.savePreferences = function(value)    {\n        var self = this;\n\n        var preferences = [{\n            'name': 'block_my_day_timetable_collapsed',\n            'value': value,\n            'userid': self.userid,\n        }];\n\n        Ajax.call([{\n            methodname: 'core_user_set_user_preferences',\n            args: {preferences: preferences},\n            done: function () {\n                Log.debug('Preference saved');\n            }\n        }]);\n    };\n\n    /**\n     * This refresh is use when navigating the timetable\n     *\n     * @method\n     **/\n    DailyTimetableControl.prototype.refreshLayout = function(htmlResult){\n        var self = this;\n\n        self.region.fadeOut(300, function() {\n            self.region.replaceWith(htmlResult);\n            self.region.show();\n            self.region = $('[data-region=\"block_my_day_timetable-instance-' + self.instanceid +'\"]');\n            self.setupEvents();\n            self.date = self.region.data(\"timetabledate\");\n            self.region.removeClass('isloading');\n            self.region.removeClass('fetchingdata');\n            self.refreshPeriodLayout();\n\n        });\n    };\n\n    DailyTimetableControl.prototype.timetableUnavailable = function() {\n        var self = this;\n\n        var unavailablestr = Str.get_string('timetableunavailable', 'block_my_day_timetable');\n        $.when(unavailablestr).done(function(localizedString) {\n            self.region.replaceWith('<h5>' + localizedString + '</h5>');\n        });\n    };\n\n    return {\n        init: init\n    };\n});"],"file":"control.min.js"}